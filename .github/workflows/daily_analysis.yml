name: Daily Weibo Product Analysis

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤©æ—©æ™š 8:15 (UTC 0:15 å’Œ 12:15) - é¿å¼€æ•´ç‚¹é«˜å³°
    - cron: '15 0,12 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½® GITHUB_TOKEN çš„æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==================== åˆ†æä»»åŠ¡ ====================
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r skills/weibo-product-analysis/requirements.txt

      - name: ğŸš€ Run Analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          WEIBO_API_URL: ${{ secrets.WEIBO_API_URL }}
          BAIDU_API_KEY: ${{ secrets.BAIDU_API_KEY }}
        run: |
          mkdir -p reports
          python skills/weibo-product-analysis/weibo_analysis.py --output reports/daily_report_$(date +'%Y%m%d').html
          
          # Debug: æ‰“å°ç›®å½•ç»“æ„æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          echo "ğŸ“‚ Listing reports directory:"
          ls -R reports/

      - name: ğŸ“¤ Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: weibo-analysis-report
          path: reports/
          if-no-files-found: error
          retention-days: 30

  # ==================== éƒ¨ç½²åˆ° GitHub Pages ====================
  deploy-to-pages:
    needs: analyze  # ä¾èµ–åˆ†æä»»åŠ¡å®Œæˆ
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ›ï¸ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¥ æ‹‰å–æœ€æ–°æäº¤
        run: git pull origin main || true

      - name: ğŸ“¥ Download Report Artifact
        uses: actions/download-artifact@v4
        with:
          name: weibo-analysis-report
          path: ./public/reports

      - name: ğŸ“ Create index.html
        run: |
          mkdir -p ./public
          
          # æ‰¾åˆ°æœ€æ–°çš„æŠ¥å‘Šæ–‡ä»¶
          LATEST_REPORT=$(ls -t ./public/reports/*.html 2>/dev/null | head -1)
          REPORT_NAME=$(basename "$LATEST_REPORT" 2>/dev/null || echo "")
          
          # ç”Ÿæˆé¦–é¡µ HTML
          cat > ./public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†æ</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      padding: 20px;
                  }
                  .container {
                      background: rgba(255,255,255,0.95);
                      border-radius: 20px;
                      padding: 40px;
                      max-width: 600px;
                      text-align: center;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                  }
                  h1 { color: #333; margin-bottom: 20px; font-size: 28px; }
                  p { color: #666; margin-bottom: 30px; line-height: 1.6; }
                  .btn {
                      display: inline-block;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      text-decoration: none;
                      padding: 15px 40px;
                      border-radius: 30px;
                      font-size: 18px;
                      font-weight: bold;
                      transition: transform 0.3s, box-shadow 0.3s;
                  }
                  .btn:hover {
                      transform: translateY(-3px);
                      box-shadow: 0 10px 30px rgba(102,126,234,0.4);
                  }
                  .update-time { color: #999; font-size: 14px; margin-top: 20px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ”¥ å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†æ</h1>
                  <p>æ¯æ—¥è‡ªåŠ¨åˆ†æå¾®åšçƒ­æœè¯é¢˜ï¼ŒæŒ–æ˜äº§å“åˆ›æ„çµæ„Ÿã€‚<br>åŸºäº AI æ™ºèƒ½åˆ†æï¼Œæä¾›æ·±åº¦æ´å¯Ÿã€‚</p>
                  <a href="./reports/" class="btn">ğŸ“Š æŸ¥çœ‹æœ€æ–°æŠ¥å‘Š</a>
                  <p class="update-time">æ›´æ–°æ—¶é—´ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 06:15</p>
              </div>
          </body>
          </html>
          EOF
          
          # ç”ŸæˆæŠ¥å‘Šåˆ—è¡¨é¡µ
          cat > ./public/reports/index.html << 'LISTEOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>æŠ¥å‘Šåˆ—è¡¨ - å¾®åšçƒ­æœåˆ†æ</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
                      background: #f5f7fa;
                      padding: 40px 20px;
                  }
                  .container { max-width: 800px; margin: 0 auto; }
                  h1 { color: #333; margin-bottom: 30px; text-align: center; }
                  .report-list { list-style: none; }
                  .report-item {
                      background: white;
                      border-radius: 10px;
                      padding: 20px;
                      margin-bottom: 15px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                      transition: transform 0.2s;
                  }
                  .report-item:hover { transform: translateX(10px); }
                  .report-item a {
                      color: #667eea;
                      text-decoration: none;
                      font-size: 18px;
                      font-weight: 500;
                  }
                  .back-link {
                      display: block;
                      text-align: center;
                      margin-top: 30px;
                      color: #667eea;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ“‹ å†å²æŠ¥å‘Šåˆ—è¡¨</h1>
                  <ul class="report-list" id="reportList"></ul>
                  <a href="../" class="back-link">â† è¿”å›é¦–é¡µ</a>
              </div>
              <script>
                  // åŠ¨æ€åˆ—å‡ºæ‰€æœ‰æŠ¥å‘Šï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…ä¼šæ˜¾ç¤ºå½“å‰ç›®å½•çš„ HTML æ–‡ä»¶ï¼‰
                  const files = [
          LISTEOF
          
          # åˆ—å‡ºæ‰€æœ‰æŠ¥å‘Šæ–‡ä»¶
          for f in $(ls -t ./public/reports/*.html 2>/dev/null | grep -v index.html); do
            name=$(basename "$f")
            echo "            '$name'," >> ./public/reports/index.html
          done
          
          cat >> ./public/reports/index.html << 'LISTEOF2'
                  ];
                  const list = document.getElementById('reportList');
                  files.forEach(f => {
                      if (f) {
                          const li = document.createElement('li');
                          li.className = 'report-item';
                          li.innerHTML = `<a href="./${f}">ğŸ“„ ${f}</a>`;
                          list.appendChild(li);
                      }
                  });
                  if (files.length === 0 || (files.length === 1 && files[0] === '')) {
                      list.innerHTML = '<li class="report-item">æš‚æ— æŠ¥å‘Š</li>';
                  }
              </script>
          </body>
          </html>
          LISTEOF2
          
          echo "ğŸ“‚ Public directory contents:"
          ls -la ./public/
          ls -la ./public/reports/

      - name: ğŸ”§ é…ç½® GitHub Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ ä¸Šä¼ åˆ° Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

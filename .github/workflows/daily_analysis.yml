name: Daily Weibo Product Analysis

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤©æ—©æ™š 8:15 (UTC 0:15 å’Œ 12:15) - é¿å¼€æ•´ç‚¹é«˜å³°
    - cron: '15 0,12 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½® GITHUB_TOKEN çš„æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==================== åˆ†æä»»åŠ¡ ====================
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸ push ä»£ç 
    steps:
      - name: ğŸ›ï¸ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r skills/weibo-product-analysis/requirements.txt

      - name: ğŸš€ Run Analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          WEIBO_API_URL: ${{ secrets.WEIBO_API_URL }}
          BAIDU_API_KEY: ${{ secrets.BAIDU_API_KEY }}
        run: |
          # é…ç½®å…·ä½“çš„ Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "WeiboAnalysisBot"
          git config --global user.email "bot@weiboanalysis.com"
          
          # æ‹‰å–æœ€æ–°ä»£ç é˜²æ­¢å†²çª
          git pull origin main || true
          
          mkdir -p reports
          
          # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å (e.g., weibo_report_20260123_0815.html)
          TIMESTAMP=$(TZ='Asia/Shanghai' date +'%Y%m%d_%H%M')
          FILENAME="reports/weibo_report_${TIMESTAMP}.html"
          
          python skills/weibo-product-analysis/weibo_analysis.py --output "$FILENAME"
          
          # æäº¤æŠ¥å‘Šåˆ°ä»“åº“ (ä½œä¸ºæ°¸ä¹…å½’æ¡£)
          git add reports/
          # å¦‚æœæœ‰æ–°ç”Ÿæˆçš„æŠ¥å‘Šæ‰æäº¤
          if [ -n "$(git status --porcelain reports/)" ]; then
            git commit -m "feat(report): Add analysis report for $TIMESTAMP"
            git push origin main
          else
            echo "âš ï¸ No changes in reports directory to commit."
          fi

  # ==================== éƒ¨ç½²åˆ° GitHub Pages ====================
  deploy-to-pages:
    needs: analyze
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ›ï¸ Checkout ä»£ç  (å«æœ€æ–°æŠ¥å‘Š)
        uses: actions/checkout@v4
        with:
          ref: main  # ğŸ‘ˆ å…³é”®ï¼šå¼ºåˆ¶ç­¾å‡ºæœ€æ–°åˆ†æ”¯ä»£ç ï¼Œè·å–åˆšæ‰æäº¤çš„æŠ¥å‘Š
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ­£ç¡®æ’åº

      - name: ğŸ Set up Python for Site Gen
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ—ï¸ æ„å»ºç«™ç‚¹ (æ³¨å…¥å¯¼èˆªæ )
        shell: python
        run: |
          import os
          import glob
          import shutil
          from datetime import datetime, timedelta, timezone
          import re

          # é…ç½®
          PUBLIC_DIR = "public"
          REPORTS_DIR = "reports"
          os.makedirs(PUBLIC_DIR, exist_ok=True)
          os.makedirs(os.path.join(PUBLIC_DIR, "reports"), exist_ok=True)

          # 1. è·å–æ‰€æœ‰æŠ¥å‘Šæ–‡ä»¶å¹¶æŒ‰æ–‡ä»¶å(åŒ…å«æ—¶é—´)å€’åºæ’åˆ—
          # å‡è®¾æ–‡ä»¶åæ ¼å¼: weibo_report_YYYYMMDD_HHMM.html æˆ– æ—§æ ¼å¼ daily_report_YYYYMMDD.html
          all_reports = sorted(glob.glob(f"{REPORTS_DIR}/*.html"), reverse=True)
          
          if not all_reports:
              print("âŒ æœªæ‰¾åˆ°ä»»ä½•æŠ¥å‘Šæ–‡ä»¶ï¼")
              exit(1)

          latest_report_path = all_reports[0]
          print(f"âœ… æœ€æ–°æŠ¥å‘Š: {latest_report_path}")

          # 2. è¯†åˆ«ä»Šå¤©çš„æŠ¥å‘Š (ç”¨äºä¸‹æ‹‰èœå•) - ä½¿ç”¨åŒ—äº¬æ—¶é—´
          beijing_now = datetime.now(timezone.utc) + timedelta(hours=8)
          today_str = beijing_now.strftime("%Y%m%d")
          todays_reports = []
          
          for r in all_reports:
              filename = os.path.basename(r)
              # åŒ¹é… YYYYMMDD
              match = re.search(r'(\d{8})', filename)
              if match and match.group(1) == today_str:
                  todays_reports.append(r)
          
          # 3. æ„å»ºå¯¼èˆªæ  HTML
          dropdown_options = ""
          for r in todays_reports:
              fname = os.path.basename(r)
              # è§£ææ—¶é—´æ˜¾ç¤º (å‡è®¾æ ¼å¼ _HHMM.html)
              time_label = "ä»Šæ—¥æŠ¥å‘Š"
              time_match = re.search(r'_(\d{4})\.html', fname)
              if time_match:
                  hhmm = time_match.group(1)
                  hour = int(hhmm[:2])
                  min_str = hhmm[2:]
                  period = "æ—©æŠ¥" if hour < 12 else "æ™šæŠ¥"
                  time_label = f"{hour}:{min_str} - {period}"
              
              # è®¾ç½®ä¸‹æ‹‰é“¾æ¥ï¼šæŒ‡å‘ reports/ ç›®å½•ä¸‹çš„æ–‡ä»¶
              # æ³¨æ„ï¼šå¦‚æœå½“å‰æ˜¯é¦–é¡µï¼Œé“¾æ¥åº”è¯¥æ˜¯ reports/xxx
              dropdown_options += f'<option value="reports/{fname}">{time_label}</option>'

          navbar_html = f"""
          <style>
            #weibo-analysis-nav {{
                position: fixed; top: 0; left: 0; right: 0;
                height: 50px; 
                background: rgba(255, 255, 255, 0.95); 
                backdrop-filter: blur(12px);
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                z-index: 9999; display: flex; align-items: center; justify-content: space-between;
                padding: 0 20px; font-family: 'Outfit', -apple-system, sans-serif;
            }}
            #weibo-analysis-nav .logo {{ font-weight: 700; font-size: 16px; color: #1e293b; display: flex; align-items: center; gap: 8px; }}
            #weibo-analysis-nav .actions {{ display: flex; align-items: center; gap: 15px; }}
            #weibo-analysis-nav select {{ 
                padding: 6px 16px; 
                border: 1px solid #e2e8f0; 
                border-radius: 20px; 
                font-size: 14px; 
                background: #f8fafc; 
                color: #334155;
                cursor: pointer;
                outline: none;
                transition: all 0.2s;
            }}
            #weibo-analysis-nav select:hover {{ border-color: #FF4757; background: #fff; }}
            
            #weibo-analysis-nav .archive-btn {{
                text-decoration: none; 
                color: #fff; 
                background: #1e293b;
                padding: 6px 20px; 
                border-radius: 20px; 
                font-size: 14px; 
                font-weight: 600;
                transition: all 0.2s;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }}
            #weibo-analysis-nav .archive-btn:hover {{ 
                transform: translateY(-1px); 
                background: #0f172a;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            }}
            body {{ padding-top: 80px !important; }}
          </style>
          <div id="weibo-analysis-nav">
              <div class="logo">
                  <span>ğŸ”¥</span> å¾®åšçƒ­æœåˆ›æ„æ´å¯Ÿ
              </div>
              <div class="actions">
                  <select onchange="if(this.value) location.href=this.value">
                      <option value="" disabled selected>ğŸ“… åˆ‡æ¢åˆ†ææŠ¥å‘Š...</option>
                      {dropdown_options}
                  </select>
                  <a href="reports/index.html" class="archive-btn">ğŸ“‚ å†å²å½’æ¡£</a>
              </div>
          </div>
          """

          # 4. ç”Ÿæˆ index.html (ä½œä¸ºæœ€æ–°æŠ¥å‘Šçš„é•œåƒ + å¯¼èˆªæ )
          with open(latest_report_path, 'r', encoding='utf-8') as f:
              content = f.read()
          
          # æ³¨å…¥å¯¼èˆªæ  (æ’å…¥åˆ° body å¼€å§‹æ ‡ç­¾å)
          if '<body' in content:
              # ç®€å•æ›¿æ¢ç¬¬ä¸€ä¸ª body æ ‡ç­¾é—­åˆå¤„
              content = re.sub(r'(<body[^>]*>)', r'\1' + navbar_html, content, count=1)
          else:
              content = navbar_html + content # å…œåº•

          # å†™å…¥ public/index.html
          with open(os.path.join(PUBLIC_DIR, "index.html"), 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("âœ… ç”Ÿæˆé¦–é¡µ index.html (æ³¨å…¥å¯¼èˆªæ )")

          # 5. å¤åˆ¶æ‰€æœ‰æŠ¥å‘Šåˆ° public/reports/ å¹¶ç”Ÿæˆå½’æ¡£é¡µ
          for r in all_reports:
              shutil.copy(r, os.path.join(PUBLIC_DIR, "reports"))
          
          # ç”Ÿæˆå½’æ¡£é¡µ HTML
          archive_list_items = ""
          for r in all_reports:
              fname = os.path.basename(r)
              date_match = re.search(r'(\d{8})', fname)
              date_display = fname
              if date_match:
                  d = date_match.group(1)
                  date_display = f"{d[:4]}-{d[4:6]}-{d[6:]}"
                  # å°è¯•æå–æ—¶é—´
                  t_match = re.search(r'_(\d{4})\.html', fname)
                  if t_match:
                      t = t_match.group(1)
                      date_display += f" {t[:2]}:{t[2:]}"
              
              archive_list_items += f"""
              <li>
                  <a href="{fname}">ğŸ“„ {fname}</a>
                  <span class="date">{date_display}</span>
              </li>
              """

          archive_html = f"""
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>å†å²å½’æ¡£ - å¾®åšçƒ­æœåˆ›æ„æ´å¯Ÿ</title>
              <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
              <style>
                :root {{
                    --primary: #FF4757;
                    --bg-dark: #0A0F1E;
                    --card-bg: rgba(255, 255, 255, 0.03);
                    --glass-border: rgba(255, 255, 255, 0.1);
                    --text-main: #E2E8F0;
                    --text-muted: #94A3B8;
                }}
                * {{ box-sizing: border-box; }}
                body {{ 
                    font-family: 'Outfit', sans-serif; 
                    background: var(--bg-dark); 
                    color: var(--text-main);
                    margin: 0; 
                    padding: 40px 20px;
                    min-height: 100vh;
                    background-image:
                        radial-gradient(circle at 0% 0%, rgba(255, 71, 87, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 100% 100%, rgba(79, 172, 254, 0.08) 0%, transparent 50%);
                }}
                .container {{ 
                    max-width: 800px; 
                    margin: 0 auto; 
                    background: var(--card-bg); 
                    backdrop-filter: blur(20px);
                    border: 1px solid var(--glass-border);
                    border-radius: 24px; 
                    overflow: hidden; 
                    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
                    animation: fadeInUp 0.8s ease-out both;
                }}
                .header {{ 
                    background: linear-gradient(135deg, rgba(255, 71, 87, 0.1) 0%, rgba(79, 172, 254, 0.1) 100%);
                    padding: 40px; 
                    text-align: center; 
                    border-bottom: 1px solid var(--glass-border);
                }}
                h1 {{ 
                    margin: 0; 
                    font-size: 2rem; 
                    font-weight: 800;
                    background: linear-gradient(to right, #FFF, #94A3B8);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                }}
                ul {{ list-style: none; padding: 0; margin: 0; }}
                li {{ 
                    padding: 20px 30px; 
                    border-bottom: 1px solid var(--glass-border); 
                    display: flex; 
                    justify-content: space-between; 
                    align-items: center;
                    transition: all 0.2s;
                }}
                li:hover {{ background: rgba(255, 255, 255, 0.05); }}
                li a {{ 
                    text-decoration: none; 
                    color: var(--text-main); 
                    font-weight: 500; 
                    font-size: 1.1rem; 
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }}
                .date {{ color: var(--text-muted); font-size: 0.9rem; font-family: 'Outfit'; }}
                .back-btn {{ 
                    display: block; 
                    text-align: center; 
                    padding: 25px; 
                    color: var(--primary); 
                    text-decoration: none; 
                    font-weight: 600;
                    border-top: 1px solid var(--glass-border);
                    transition: background 0.3s;
                }}
                .back-btn:hover {{ background: rgba(255, 71, 87, 0.1); }}
                
                @keyframes fadeInUp {{
                    from {{ opacity: 0; transform: translateY(20px); }}
                    to {{ opacity: 1; transform: translateY(0); }}
                }}
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸ“‚ å†å²æŠ¥å‘Šå½’æ¡£</h1>
                  </div>
                  <ul>{archive_list_items}</ul>
                  <a href="../" class="back-btn">â† è¿”å›æœ€æ–°æŠ¥å‘Š</a>
              </div>
          </body>
          </html>
          """
          
          with open(os.path.join(PUBLIC_DIR, "reports", "index.html"), 'w', encoding='utf-8') as f:
              f.write(archive_html)
          
          print("âœ… ç”Ÿæˆå½’æ¡£é¡µ reports/index.html")

      - name: ğŸ”§ é…ç½® GitHub Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ ä¸Šä¼ åˆ° Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
